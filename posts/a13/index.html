<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">

<meta itemprop="name" content="openf-falcon安装">
<meta itemprop="description" content="openf-falcon安装  环境准备：https://book.open-falcon.org/zh_0_2/quick_install/prepare.html 参考博客：https://www.cnblogs.com/yaohong/p/8713723.html 1、依赖组件 1）安装一些基本工具（与open-falcon无关） yum install -y wget yum install -y vim yum install -y git 2） 安装redis yum install -y redis systemctl start redis # 启动redis systemctl enable redis # 设置redis开机启动 systemctl status redis # 查看redis是否开启 3）安装mysql wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm # 下载repo源 rpm -ivh mysql-community-release-el7-5.noarch.rpm # 安装该rpm包 yum install mysql-server -y # 安装mysql systemctl start mysql systemctl status mysql 4）初始化mysql表结构 复制代码 cd /tmp/ &amp;&amp; git clone https://github.com/open-falcon/falcon-plus.git cd /tmp/falcon-plus/scripts/mysql/db_schema/ mysql -h 127.">


<meta itemprop="datePublished" content="2019-02-20T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-02-20T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1422">



<meta itemprop="keywords" content="" />
<meta property="og:title" content="openf-falcon安装" />
<meta property="og:description" content="openf-falcon安装  环境准备：https://book.open-falcon.org/zh_0_2/quick_install/prepare.html 参考博客：https://www.cnblogs.com/yaohong/p/8713723.html 1、依赖组件 1）安装一些基本工具（与open-falcon无关） yum install -y wget yum install -y vim yum install -y git 2） 安装redis yum install -y redis systemctl start redis # 启动redis systemctl enable redis # 设置redis开机启动 systemctl status redis # 查看redis是否开启 3）安装mysql wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm # 下载repo源 rpm -ivh mysql-community-release-el7-5.noarch.rpm # 安装该rpm包 yum install mysql-server -y # 安装mysql systemctl start mysql systemctl status mysql 4）初始化mysql表结构 复制代码 cd /tmp/ &amp;&amp; git clone https://github.com/open-falcon/falcon-plus.git cd /tmp/falcon-plus/scripts/mysql/db_schema/ mysql -h 127." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/a13/" />
<meta property="article:published_time" content="2019-02-20T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-02-20T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="openf-falcon安装"/>
<meta name="twitter:description" content="openf-falcon安装  环境准备：https://book.open-falcon.org/zh_0_2/quick_install/prepare.html 参考博客：https://www.cnblogs.com/yaohong/p/8713723.html 1、依赖组件 1）安装一些基本工具（与open-falcon无关） yum install -y wget yum install -y vim yum install -y git 2） 安装redis yum install -y redis systemctl start redis # 启动redis systemctl enable redis # 设置redis开机启动 systemctl status redis # 查看redis是否开启 3）安装mysql wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm # 下载repo源 rpm -ivh mysql-community-release-el7-5.noarch.rpm # 安装该rpm包 yum install mysql-server -y # 安装mysql systemctl start mysql systemctl status mysql 4）初始化mysql表结构 复制代码 cd /tmp/ &amp;&amp; git clone https://github.com/open-falcon/falcon-plus.git cd /tmp/falcon-plus/scripts/mysql/db_schema/ mysql -h 127."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>openf-falcon安装</title>
	<link rel="stylesheet" href="/css/style.min.568c54a56780af2a70c45272522247710b69dbfc080b315211fb98381e3796f8.css" integrity="sha256-VoxUpWeArypwxFJyUiJHcQtp2/wICzFSEfuYOB43lvg=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="/">孙志奇的个人博客</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="/posts/">博客</a>
				<a href="/about-hugo/">关于我</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://instagram.com/" target="_blank" rel="noopener me" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-instagram"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a><a href="https://github.com/" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="/posts/">博客</a></li>
			<li><a href="/about-hugo/">关于我</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Feb 20, 2019</span></div>
				<h1>openf-falcon安装</h1>
			</header>
			<div class="content">
				

<h1 id="openf-falcon安装">openf-falcon安装<a href="#openf-falcon安装" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>

<pre><code> 环境准备：https://book.open-falcon.org/zh_0_2/quick_install/prepare.html

　　   参考博客：https://www.cnblogs.com/yaohong/p/8713723.html

　　1、依赖组件

　　　　1）安装一些基本工具（与open-falcon无关）

　　　　　　　　yum install -y wget

　　　　　　　　yum install -y vim

　　　　　　　　yum install -y git

　　　　2） 安装redis

　　　　　　　　yum install -y redis

　　　　　　　　systemctl start redis     # 启动redis

　　　　　　　　systemctl enable redis      # 设置redis开机启动

　　　　　　　　systemctl status redis    # 查看redis是否开启

　　　　3）安装mysql

　　　　　　　　wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm      # 下载repo源

　　　　　　　　rpm -ivh mysql-community-release-el7-5.noarch.rpm                                    # 安装该rpm包

　　　　　　　　yum install mysql-server -y                                                                           # 安装mysql

　　　　　　　　systemctl start mysql

　　　　　　　　systemctl status mysql

　　　　4）初始化mysql表结构

复制代码
cd /tmp/ &amp;&amp; git clone https://github.com/open-falcon/falcon-plus.git 
cd /tmp/falcon-plus/scripts/mysql/db_schema/
mysql -h 127.0.0.1 -u root -p &lt; 1_uic-db-schema.sql
mysql -h 127.0.0.1 -u root -p &lt; 2_portal-db-schema.sql
mysql -h 127.0.0.1 -u root -p &lt; 3_dashboard-db-schema.sql
mysql -h 127.0.0.1 -u root -p &lt; 4_graph-db-schema.sql
mysql -h 127.0.0.1 -u root -p &lt; 5_alarms-db-schema.sql
rm -rf /tmp/falcon-plus/
复制代码
　　2、安装Go语言开发环境 &amp; 编译打包 open-falcon-v0.2.1.tar.gz

　　　　 注：https://book.open-falcon.org/zh_0_2/quick_install/prepare.html 中官方有提供编译包，如果编译过程不顺利可以直接下载编译包。

　　　　1）安装go语言环境

　　　　　　　　yum install -y epel-release

　　　　　　　　yum install golang -y

　　　　　　　　go version                   # 确认是否满足官方要求的Go &gt;= 1.6

　　　　2）设置环境变量GOROOT和GOPATH

　　　　　　　　export GOROOT=/usr/lib/golang

　　　　　　　　export GOPATH=/home

　　　　3）将open-falcon的源码从github上get下来

　　　　　　　　mkdir -p $GOPATH/src/github.com/open-falcon        # 创建GOPATH下的一个本地的路径

　　　　　　　　cd $GOPATH/src/github.com/open-falcon                   # 进入该路径

　　　　　　　　git clone https://github.com/open-falcon/falcon-plus.git                    # 将源码get到本地

　　　　4）编译源码并打包 open-falcon-v0.2.1.tar.gz

　　　　　　　　cd $GOPATH/src/github.com/open-falcon/falcon-plus/                     # 进入本地源码路径下

　　　　　　　　go get github.com/open-falcon/rrdlite               # 使用go get获取rrdtool工具包（make过程卡壳的一个点）

　　　　　　　　make all                                                          # 编译所有模块

　　　　　　　　make pack                                                        # 打包

 　　　　　　　　注：在$GOPATH/src/github.com/open-falcon/falcon-plus/ 目录下就多了刚才的压缩包 “open-falcon-v0.2.1.tar.gz”。

1.2 部署open-falcon后端     返回顶部
　　https://book.open-falcon.org/zh_0_2/quick_install/backend.html

　　1、创建工作目录

　　　　　　export WORKSPACE=/home/work

　　　　　　mkdir -p $WORKSPACE

　　2、解压二进制包（包名根据实际进行修改） 

　　　　　　cd $GOPATH/src/github.com/open-falcon/falcon-plus/

　　　　　　tar -xzvf open-falcon-v0.2.1.tar.gz -C $WORKSPACE

　　　　　　注：由于我是根据本教程编译源码获得的压缩包，故需要切换到“$GOPATH/src/github.com/open-falcon/falcon-plus/”路径下。

　　　　　　      包名由于make pack的时候就是open-falcon-v0.2.0.tar.gz，具体根据实际情况（17/12/6再部署时发现官方已有0.2.1）。

　　3、修改配置文件说明

　　　　　　下面这些模块需要使用mysql数据库，将下面文件的mysql用户名密码替换成真实的即可

模块  配置文件所在路径
aggregator      /home/work/aggregator/config/cfg.json
graph   /home/work/graph/config/cfg.json
hbs /home/work/hbs/config/cfg.json
nodata  /home/work/nodata/config/cfg.json
api /home/work/api/config/cfg.json
alarm   /home/work/alarm/config/cfg.json
　　4、启动后端命令

cd $WORKSPACE
./open-falcon start

# 检查所有模块的启动状况
./open-falcon check
1.2.1 agent配置文件     返回顶部
　　1、agent（数据采集组件）：golang项目

　　　　　　1. 需要监控的服务器都要安装falcon-agent，falcon-agent是一个golang开发的daemon程序，用于自发现的采集单机的各种数据和指标

　　　　　　2. falcon-agent提供了一个proxy-gateway，用户可以方便的通过http接口，push数据到本机的gateway

　　　　　　3. gateway会将用户push的数据转发到server端，所有自实现的插件都使用这个REST接口传送数据。。

　　　　　　4. 部署好agent后，能自动获取到系统的基础监控指标，并上报给transfer，agent与transfer建立了TCP长连接，每隔60秒发送一次数据到transfer。

　　2、配置说明

　　　　　　http://192.168.56.12:1988/ 

　　　　　　vim /home/work/agent/config/cfg.json 


复制代码
{
    &quot;debug&quot;: true,    # 控制一些debug信息的输出，生产环境通常设置为false
    &quot;hostname&quot;: &quot;&quot;,   # agent采集了数据发给transfer，endpoint就设置为了hostname，默认通过`hostname`获取，如果配置中配置了hostname，就用配置中的
    &quot;ip&quot;: &quot;&quot;,         # agent与hbs心跳的时候会把自己的ip地址发给hbs，agent会自动探测本机ip，如果不想让agent自动探测，可以手工修改该配置
    &quot;plugin&quot;: {
        &quot;enabled&quot;: false,                   # 默认不开启插件机制
        &quot;dir&quot;: &quot;./plugin&quot;,                  # 把放置插件脚本的git repo clone到这个目录
        &quot;git&quot;: &quot;https://github.com/open-falcon/plugin.git&quot;, # 放置插件脚本的git repo地址
        &quot;logs&quot;: &quot;./logs&quot;                                    # 插件执行的log，如果插件执行有问题，可以去这个目录看log
    },
    &quot;heartbeat&quot;: {
        &quot;enabled&quot;: true,                      # 此处enabled要设置为true
        &quot;addr&quot;: &quot;127.0.0.1:6030&quot;,             # hbs的地址，端口是hbs的rpc端口
        &quot;interval&quot;: 60,                       # 心跳周期，单位是秒
        &quot;timeout&quot;: 1000                       # 连接hbs的超时时间，单位是毫秒
    },
    &quot;transfer&quot;: {
        &quot;enabled&quot;: true, 
        &quot;addrs&quot;: [
            &quot;127.0.0.1:18433&quot;
        ],                          # transfer的地址，端口是transfer的rpc端口, 可以支持写多个transfer的地址，agent会保证HA
        &quot;interval&quot;: 60,             # 采集周期，单位是秒，即agent一分钟采集一次数据发给transfer
        &quot;timeout&quot;: 1000             # 连接transfer的超时时间，单位是毫秒
    },
    &quot;http&quot;: {
        &quot;enabled&quot;: true,            # 是否要监听http端口
        &quot;listen&quot;: &quot;:1988&quot;,
        &quot;backdoor&quot;: false
    },
    &quot;collector&quot;: {
        &quot;ifacePrefix&quot;: [&quot;eth&quot;, &quot;em&quot;],  # 默认配置只会采集网卡名称前缀是eth、em的网卡流量，配置为空就会采集所有的，lo的也会采集。可以从/proc/net/dev看到各个网卡的流量信息
        &quot;mountPoint&quot;: []
    },
    &quot;default_tags&quot;: {
    },
    &quot;ignore&quot;: {                        # 默认采集了200多个metric，可以通过ignore设置为不采集
        &quot;cpu.busy&quot;: true,
        &quot;df.bytes.free&quot;: true,
        &quot;df.bytes.total&quot;: true,
        &quot;df.bytes.used&quot;: true,
        &quot;df.bytes.used.percent&quot;: true,
        &quot;df.inodes.total&quot;: true,
        &quot;df.inodes.free&quot;: true,
        &quot;df.inodes.used&quot;: true,
        &quot;df.inodes.used.percent&quot;: true,
        &quot;mem.memtotal&quot;: true,
        &quot;mem.memused&quot;: true,
        &quot;mem.memused.percent&quot;: true,
        &quot;mem.memfree&quot;: true,
        &quot;mem.swaptotal&quot;: true,
        &quot;mem.swapused&quot;: true,
        &quot;mem.swapfree&quot;: true
    }
}
复制代码
　　3、进程管理

　　　　　　./open-falcon start agent                  启动进程

　　　　　　./open-falcon stop agent                  停止进程

　　　　　　./open-falcon monitor agent             查看日志

　　4、验证agent是否正常

　　　　　　cd /home/work/agent/bin/

　　　　　　./falcon-agent --check

　　　　　　curl 127.0.0.1:1988/config/reload       # 重载agent配置

　　5、/v1/push接口，监控脚本定制

　　　　　　ts=`date +%s`; curl -X POST -d &quot;[{\&quot;metric\&quot;: \&quot;metric.demo\&quot;, \&quot;endpoint\&quot;: \&quot;qd-open-falcon-judge01.hd\&quot;, \&quot;timestamp\&quot;: $ts,\&quot;step\&quot;: 60,\&quot;value\&quot;: 9,\&quot;counterType\&quot;: \&quot;GAUGE\&quot;,\&quot;tags\&quot;: \&quot;project=falcon,module=judge\&quot;}]&quot; http://127.0.0.1:1988/v1/push

1.2.2 transfer（数据上报）     返回顶部
　　1、transfer（数据上报）

　　　　　　1. transfer进程负责分发从agent上送的监控指标数据，并根据哈希分片。

　　　　　　2. 将数据分发给judge进程和graph进程，供告警判定和绘图。

　　2、服务管理

　　　　　　./open-falcon start transfer                     # 启动服务

　　　　　　curl -s &quot;127.0.0.1:6060/health&quot;              # 校验服务,这里假定服务开启了6060的http监听端口。检验结果为ok表明服务正常启动。

　　　　　　./open-falcon stop transfer                     # 停止服务

　　　　　　./open-falcon monitor transfer                # 查看日志

　　3、补充说明

　　　　　　部署完成transfer组件后，请修改agent的配置，使其指向正确的transfer地址。

　　　　　　在安装完graph和judge后，请修改transfer的相应配置、使其能够正确寻址到这两个组件。

　　4、配置说明


复制代码
{
    &quot;debug&quot;: true,      # 如果为true，日志中会打印debug信息
    &quot;minStep&quot;: 30,      # 允许上报的数据最小间隔，默认为30秒
    &quot;http&quot;: {
        &quot;enabled&quot;: true,                # 表示是否开启该http端口，该端口为控制端口，主要用来对transfer发送控制命令、统计命令、debug命令等
        &quot;listen&quot;: &quot;0.0.0.0:6060&quot;        # 表示监听的http端口
    },
    &quot;rpc&quot;: {
        &quot;enabled&quot;: true,                # 表示是否开启该jsonrpc数据接收端口, Agent发送数据使用的就是该端口
        &quot;listen&quot;: &quot;0.0.0.0:8433&quot;        # 表示监听的http端口
    },
    &quot;socket&quot;: {                         # 即将被废弃,请避免使用
        &quot;enabled&quot;: true,
        &quot;listen&quot;: &quot;0.0.0.0:4444&quot;,
        &quot;timeout&quot;: 3600
    },
    &quot;judge&quot;: { 
        &quot;enabled&quot;: true,                # 表示是否开启向judge发送数据
        &quot;batch&quot;: 200,                   # 数据转发的批量大小，可以加快发送速度，建议保持默认值
        &quot;connTimeout&quot;: 1000,            # 单位是毫秒，与后端建立连接的超时时间，可以根据网络质量微调，建议保持默认
        &quot;callTimeout&quot;: 5000,            # 单位是毫秒，发送数据给后端的超时时间，可以根据网络质量微调，建议保持默认
        &quot;maxConns&quot;: 32,                 # 连接池相关配置，最大连接数，建议保持默认
        &quot;maxIdle&quot;: 32,                  # 连接池相关配置，最大空闲连接数，建议保持默认
        &quot;replicas&quot;: 500,                # 这是一致性hash算法需要的节点副本数量，建议不要变更，保持默认即可
        &quot;cluster&quot;: {                    # key-value形式的字典，表示后端的judge列表，其中key代表后端judge名字，value代表的是具体的ip:port
            &quot;judge-00&quot; : &quot;0.0.0.0:6080&quot;
        }
    },
    &quot;graph&quot;: {
        &quot;enabled&quot;: true,                # 表示是否开启向graph发送数据
        &quot;batch&quot;: 200,
        &quot;connTimeout&quot;: 1000,
        &quot;callTimeout&quot;: 5000,
        &quot;maxConns&quot;: 32,
        &quot;maxIdle&quot;: 32,
        &quot;replicas&quot;: 500,
        &quot;cluster&quot;: {                      # key-value形式的字典，表示后端的graph列表，其中key代表后端graph名字，value代表的是具体的ip:port
            &quot;graph-00&quot; : &quot;0.0.0.0:6070&quot;   # (多个地址用逗号隔开, transfer会将同一份数据发送至各个地址，利用这个特性可以实现数据的多重备份)
        }
    },
    &quot;tsdb&quot;: {
        &quot;enabled&quot;: false,                 # 表示是否开启向open tsdb发送数据
        &quot;batch&quot;: 200,
        &quot;connTimeout&quot;: 1000,
        &quot;callTimeout&quot;: 5000,
        &quot;maxConns&quot;: 32,
        &quot;maxIdle&quot;: 32,
        &quot;retry&quot;: 3,                       # 连接后端的重试次数和发送数据的重试次数
        &quot;address&quot;: &quot;127.0.0.1:8088&quot;       # tsdb地址或者tsdb集群vip地址, 通过tcp连接tsdb.
    }
}
复制代码
1.2.3 judge（告警判断）     返回顶部
　　1、judge（告警判断）

　　　　　　1.Judge从Heartbeat server获取所有的报警策略，并判断transfer推送的指标数据是否触发告警。

　　　　　　2. 若触发了告警，judge将会产生告警事件，这些告警事件会写入Redis（使用Redis消息队列）。

　　　　　　3. redis中告警事件，供处理告警事件的Alarm进程转发告警消息，或是Email，或是手机短信等。

　　2、部署说明

　　　　　　1. Judge监听了一个http端口，提供了一个http接口：/count，访问之，可以得悉当前Judge实例处理了多少数据量。

　　　　　　2. 推荐的做法是一个Judge实例处理50万~100万数据，用个5G~10G内存，如果所用物理机内存比较大，比如有128G，可以在一个物理机上部署多个Judge实例。

　　3、进程管理

　　　　　　1. ./open-falcon start judge     # 启动

　　　　　　2. ./open-falcon stop judge      # 停止

　　　　　　3. ./open-falcon monitor judge         # 查看日志

　　4、配置说明


复制代码
{
    &quot;debug&quot;: true,
    &quot;debugHost&quot;: &quot;nil&quot;,
    &quot;remain&quot;: 11,
    &quot;http&quot;: {
        &quot;enabled&quot;: true,
        &quot;listen&quot;: &quot;0.0.0.0:6081&quot;
    },
    &quot;rpc&quot;: {
        &quot;enabled&quot;: true,
        &quot;listen&quot;: &quot;0.0.0.0:6080&quot;
    },
    &quot;hbs&quot;: {
        &quot;servers&quot;: [&quot;127.0.0.1:6030&quot;],       # hbs最好放到lvs vip后面，所以此处最好配置为vip:port
        &quot;timeout&quot;: 300,
        &quot;interval&quot;: 60
    },
    &quot;alarm&quot;: {
        &quot;enabled&quot;: true,
        &quot;minInterval&quot;: 300,                  # 连续两个报警之间至少相隔的秒数，维持默认即可
        &quot;queuePattern&quot;: &quot;event:p%v&quot;,
        &quot;redis&quot;: {
            &quot;dsn&quot;: &quot;127.0.0.1:6379&quot;,         # 与alarm、sender使用一个redis
            &quot;maxIdle&quot;: 5,
            &quot;connTimeout&quot;: 5000,
            &quot;readTimeout&quot;: 5000,
            &quot;writeTimeout&quot;: 5000
        }
    }
}
复制代码
1.2.4 Alarm（告警）     返回顶部
　　1、Alarm（告警）

　　　　　　1. Alarm进程监听Redis中的消息队列，并将judge产生的告警事件转发给微信、短信和邮件三种REST接口，REST接口才是具体的发送动作。

　　　　　　2. 另外，关于告警，每条告警策略都会定义不同的优先级，Redis中的消息队列也按优先级划分。

　　　　　　3. Alarm不仅消费告警事件，优先级比较低的报警，其合并逻辑都是在alarm中做，所以目前Alarm进程只能部署一个实例。

　　　　　　4. 已经发送出去的告警事件，Alarm将会负责写入MySQL。

　　　　　　说明：

　　　　　　　　1）我们在配置报警策略的时候配置了报警级别，比如P0/P1/P2等等，每个及别的报警都会对应不同的redis队列 

　　　　　　　　2）alarm去读取这个数据的时候我们希望先读取P0的数据，再读取P1的数据，最后读取P5的数据，因为我们希望先处理优先级高的。

　　　　　　注：alarm是个单点。对于未恢复的告警是放到alarm的内存中的，alarm还需要做报警合并，故而alarm只能部署一个实例。后期需要想办法改进。

　　2、部署说明

　　　　　　1. alarm是个单点，对于未恢复的告警是放到alarm的内存中的，alarm还需要做报警合并，故而alarm只能部署一个实例。需要对alarm的存活做好监控。

　　3、进程管理

　　　　　　./open-falcon start alarm         # 启动

　　　　　　./open-falcon stop alarm           # 停止

　　　　　　./open-falcon monitor alarm     # 查看日志

　　4、配置说明


复制代码
{
    &quot;log_level&quot;: &quot;debug&quot;,
    &quot;http&quot;: {
        &quot;enabled&quot;: true,
        &quot;listen&quot;: &quot;0.0.0.0:9912&quot;
    },
    &quot;redis&quot;: {
        &quot;addr&quot;: &quot;127.0.0.1:6379&quot;,
        &quot;maxIdle&quot;: 5,
        &quot;highQueues&quot;: [
            &quot;event:p0&quot;,
            &quot;event:p1&quot;,
            &quot;event:p2&quot;
        ],
        &quot;lowQueues&quot;: [
            &quot;event:p3&quot;,
            &quot;event:p4&quot;,
            &quot;event:p5&quot;,
            &quot;event:p6&quot;
        ],
        &quot;userIMQueue&quot;: &quot;/queue/user/im&quot;,
        &quot;userSmsQueue&quot;: &quot;/queue/user/sms&quot;,
        &quot;userMailQueue&quot;: &quot;/queue/user/mail&quot;
    },
    &quot;api&quot;: {
        &quot;im&quot;: &quot;http:#127.0.0.1:10086/wechat&quot;,      #微信发送网关地址
        &quot;sms&quot;: &quot;http:#127.0.0.1:10086/sms&quot;,        #短信发送网关地址
        &quot;mail&quot;: &quot;http:#127.0.0.1:10086/mail&quot;,      #邮件发送网关地址
        &quot;dashboard&quot;: &quot;http:#127.0.0.1:8081&quot;,       #dashboard模块的运行地址
        &quot;plus_api&quot;:&quot;http:#127.0.0.1:8080&quot;,         #falcon-plus api模块的运行地址
        &quot;plus_api_token&quot;: &quot;default-token-used-in-server-side&quot;       #用于和falcon-plus api模块服务端之间的通信认证token
    },
    &quot;falcon_portal&quot;: {
        &quot;addr&quot;: &quot;root:@tcp(127.0.0.1:3306)/alarms?charset=utf8&amp;loc=Asia%2FChongqing&quot;,
        &quot;idle&quot;: 10,
        &quot;max&quot;: 100
    },
    &quot;worker&quot;: {
        &quot;im&quot;: 10,
        &quot;sms&quot;: 10,
        &quot;mail&quot;: 50
    },
    &quot;housekeeper&quot;: {
        &quot;event_retention_days&quot;: 7,    #报警历史信息的保留天数
        &quot;event_delete_batch&quot;: 100
    }
}
复制代码
　　5、报警合并

　　　　　　1. 如果某个核心服务挂了，可能会造成大面积报警，为了减少报警短信数量，我们做了报警合并功能。

　　　　　　2. 把报警信息写入dashboard模块，然后dashboard返回一个url地址给alarm，alarm将这个url链接发给用户，
　　　　　　    这样用户只要收到一条短信（里边是个url地址），点击url进去就是多条报警内容。

　　　　　　3. highQueues中配置的几个event队列中的事件是不会做报警合并的，因为那些是高优先级的报警，报警合并只是针对lowQueues中的事件。

　　　　　　4. 如果所有的事件都不想做报警合并，就把所有的event队列都配置到highQueues中即可

1.2.5 graph（数据存储&amp;归档）     返回顶部
　　1、graph（数据存储&amp;归档）

　　　　　　1. graph进程接收从transfer推送来的指标数据，操作rrd文件存储监控数据。

　　　　　　2. graph也为API进程提供查询接口，处理query组件的查询请求、返回绘图数据。

　　2、进程管理

　　　　　　./open-falcon start graph            # 启动服务

　　　　　　./open-falcon stop graph             # 停止服务　　　　

　　　　　　./open-falcon monitor graph        # 查看日志

　　　　　　注：部署完graph组件后，请修改transfer和api的配置，使这两个组件可以寻址到graph。

　　3、配置说明


复制代码
{
    &quot;debug&quot;: false,                  #true or false, 是否开启debug日志
    &quot;http&quot;: {
        &quot;enabled&quot;: true,             #true or false, 表示是否开启该http端口，该端口为控制端口，主要用来对graph发送控制命令、统计命令、debug命令
        &quot;listen&quot;: &quot;0.0.0.0:6071&quot;     #表示监听的http端口
    },
    &quot;rpc&quot;: {
        &quot;enabled&quot;: true,             #true or false, 表示是否开启该rpc端口，该端口为数据接收端口
        &quot;listen&quot;: &quot;0.0.0.0:6070&quot;     #表示监听的rpc端口
    },
    &quot;rrd&quot;: {
        &quot;storage&quot;: &quot;./data/6070&quot;     # 历史数据的文件存储路径（如有必要，请修改为合适的路）
    },
    &quot;db&quot;: {
        &quot;dsn&quot;: &quot;root:@tcp(127.0.0.1:3306)/graph?loc=Local&amp;parseTime=true&quot;, #MySQL的连接信息，默认用户名是root，密码为空，host为127.0.0.1，database为graph（如有必要，请修改)
        &quot;maxIdle&quot;: 4                 #MySQL连接池配置，连接池允许的最大连接数，保持默认即可
    },
    &quot;callTimeout&quot;: 5000,             #RPC调用超时时间，单位ms
    &quot;ioWorkerNum&quot;: 64,               #底层io.Worker的数量, 注意: 这个功能是v0.2.1版本之后引入的，v0.2.1版本之前的配置文件不需要该参数
    &quot;migrate&quot;: {                     #扩容graph时历史数据自动迁移
        &quot;enabled&quot;: false,            #true or false, 表示graph是否处于数据迁移状态
        &quot;concurrency&quot;: 2,            #数据迁移时的并发连接数，建议保持默认
        &quot;replicas&quot;: 500,             #这是一致性hash算法需要的节点副本数量，建议不要变更，保持默认即可（必须和transfer的配置中保持一致）
        &quot;cluster&quot;: {                 #未扩容前老的graph实例列表
            &quot;graph-00&quot; : &quot;127.0.0.1:6070&quot;
        }
    }
}
复制代码
1.2.6 API     返回顶部
　　1、API（提供统一的restAPI操作接口） ：go的后端模块

　　　　　　1. API组件，提供统一的绘图数据查询入口 （提供http接口））。

　　　　　　2. API组件接收查询请求，根据一致性哈希算法去相应的graph实例查询不同metric的数据，然后汇总拿到的数据，最后统一返回给用户。

　　　　　　补充说明：

　　　　　　　　部署完成api组件后，请修改dashboard组件的配置、使其能够正确寻址到api组件。

　　　　　　　　请确保api组件的graph列表 与 transfer的配置 一致。

　　2、进程管理

　　　　　　./open-falcon start api                # 启动服务

　　　　　　./open-falcon stop api                # 停止服务

　　　　　　./open-falcon monitor api           # 查看日志

　　3、配置说明


复制代码
{
    &quot;log_level&quot;: &quot;debug&quot;,
    &quot;db&quot;: {                       //数据库相关的连接配置信息
        &quot;faclon_portal&quot;: &quot;root:@tcp(127.0.0.1:3306)/falcon_portal?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;,
        &quot;graph&quot;: &quot;root:@tcp(127.0.0.1:3306)/graph?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;,
        &quot;uic&quot;: &quot;root:@tcp(127.0.0.1:3306)/uic?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;,
        &quot;dashboard&quot;: &quot;root:@tcp(127.0.0.1:3306)/dashboard?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;,
        &quot;alarms&quot;: &quot;root:@tcp(127.0.0.1:3306)/alarms?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;,
        &quot;db_bug&quot;: true
    },
    &quot;graphs&quot;: {                  // graph模块的部署列表信息
        &quot;cluster&quot;: {
            &quot;graph-00&quot;: &quot;127.0.0.1:6070&quot;
        },
        &quot;max_conns&quot;: 100,
        &quot;max_idle&quot;: 100,
        &quot;conn_timeout&quot;: 1000,
        &quot;call_timeout&quot;: 5000,
        &quot;numberOfReplicas&quot;: 500
    },
    &quot;metric_list_file&quot;: &quot;./api/data/metric&quot;,
    &quot;web_port&quot;: &quot;:8080&quot;,                       // http监听端口
    &quot;access_control&quot;: true,                    // 如果设置为false，那么任何用户都可以具备管理员权限
    &quot;salt&quot;: &quot;pleaseinputwhichyouareusingnow&quot;,  //数据库加密密码的时候的salt
    &quot;skip_auth&quot;: false,                        //如果设置为true，那么访问api就不需要经过认证
    &quot;default_token&quot;: &quot;default-token-used-in-server-side&quot;,         //用于服务端各模块间的访问授权
    &quot;gen_doc&quot;: false,
    &quot;gen_doc_path&quot;: &quot;doc/module.html&quot;
}
复制代码
1.2.7 Aggregator     返回顶部
　　1、Aggregator

　　　　　　1. 集群聚合模块，聚合某集群下的所有机器的某个指标的值，提供一种集群视角的监控体验。

　　2、进程管理

　　　　　　./open-falcon start aggregator                  # 启动服务

　　　　　　./open-falcon monitor aggregator              # 检查log

　　　　　　./open-falcon stop aggregator                 # 停止服务

　　3、配置说明


复制代码
{
    &quot;debug&quot;: true,
    &quot;http&quot;: {
        &quot;enabled&quot;: true,
        &quot;listen&quot;: &quot;0.0.0.0:6055&quot;
    },
    &quot;database&quot;: {
        &quot;addr&quot;: &quot;root:@tcp(127.0.0.1:3306)/falcon_portal?loc=Local&amp;parseTime=true&quot;,
        &quot;idle&quot;: 10,
        &quot;ids&quot;: [1, -1],
        &quot;interval&quot;: 55
    },
    &quot;api&quot;: {
        &quot;connect_timeout&quot;: 500,
        &quot;request_timeout&quot;: 2000,
        &quot;plus_api&quot;: &quot;http://127.0.0.1:8080&quot;,                           #falcon-plus api模块的运行地址
        &quot;plus_api_token&quot;: &quot;default-token-used-in-server-side&quot;,         #和falcon-plus api 模块交互的认证token
        &quot;push_api&quot;: &quot;http://127.0.0.1:1988/v1/push&quot;                    #push数据的http接口，这是agent提供的接口
    }
}
复制代码
1.2.8 Nodata     返回顶部
　　1、Nodata

　　　　　　1. nodata用于检测监控数据的上报异常。

　　　　　　2. nodata和实时报警judge模块协同工作，过程为: 配置了nodata的采集项超时未上报数据，nodata生成一条默认的模拟数据；

　　　　　　3. 用户配置相应的报警策略，收到mock数据就产生报警。

　　　　　　4. 采集项上报异常检测，作为judge模块的一个必要补充，能够使judge的实时报警功能更加可靠、完善。

　　2、进程管理

　　　　　　./open-falcon start nodata              # 启动服务

　　　　　　./open-falcon stop nodata             # 停止服务

　　　　　　./open-falcon monitor nodata          # 检查日志

　　3、配置说明


复制代码
{
    &quot;debug&quot;: true,
    &quot;http&quot;: {
        &quot;enabled&quot;: true,
        &quot;listen&quot;: &quot;0.0.0.0:6090&quot;
    },
    &quot;plus_api&quot;:{
        &quot;connectTimeout&quot;: 500,
        &quot;requestTimeout&quot;: 2000,
        &quot;addr&quot;: &quot;http://127.0.0.1:8080&quot;,                 #falcon-plus api模块的运行地址
        &quot;token&quot;: &quot;default-token-used-in-server-side&quot;     #用于和falcon-plus api模块的交互认证token
    },
    &quot;config&quot;: {
        &quot;enabled&quot;: true,
        &quot;dsn&quot;: &quot;root:@tcp(127.0.0.1:3306)/falcon_portal?loc=Local&amp;parseTime=true&amp;wait_timeout=604800&quot;,
        &quot;maxIdle&quot;: 4
    },
    &quot;collector&quot;:{
        &quot;enabled&quot;: true,
        &quot;batch&quot;: 200,
        &quot;concurrent&quot;: 10
    },
    &quot;sender&quot;:{
        &quot;enabled&quot;: true,
        &quot;connectTimeout&quot;: 500,
        &quot;requestTimeout&quot;: 2000,
        &quot;transferAddr&quot;: &quot;127.0.0.1:6060&quot;,                #transfer的http监听地址,一般形如&quot;domain.transfer.service:6060&quot;
        &quot;batch&quot;: 500
    }
}
复制代码
1.3 部署前端(dashboard)     返回顶部
　　1、创建工作目录

export FRONTSPACE=/home/front/open-falcon
mkdir -p $FRONTSPACE
　　2、克隆前端组件代码

cd $FRONTSPACE
git clone https://github.com/open-falcon/dashboard.git
　　3、安装依赖包

复制代码
yum install -y python-virtualenv
yum install -y python-devel
yum install -y openldap-devel
yum install -y mysql-devel
yum groupinstall &quot;Development tools&quot; -y

cd $FRONTSPACE/dashboard/
virtualenv ./env

./env/bin/pip install -r pip_requirements.txt
复制代码
　　4、修改配置

　　　　　　注：由于前端后台搭在一台虚拟机里，且暂时不接入LDAP，且数据库root的密码为空，故先不修改配置文件。

复制代码
# dashboard的配置文件为： '/home/front/open-falcon/dashboard/rrd/config.py'，请根据实际情况修改

#1、portal database
PORTAL_DB_USER = os.environ.get(&quot;PORTAL_DB_USER&quot;,&quot;root&quot;)
PORTAL_DB_PASS = os.environ.get(&quot;PORTAL_DB_PASS&quot;,&quot;1&quot;)

#2、alarm database
ALARM_DB_USER = os.environ.get(&quot;ALARM_DB_USER&quot;,&quot;root&quot;)
ALARM_DB_PASS = os.environ.get(&quot;ALARM_DB_PASS&quot;,&quot;1&quot;)
复制代码
　　5、启动服务

　　　　浏览器打开： http://192.168.56.12:8081

　　　　1）开发者模式启动

　　　　　　　　cd $FRONTSPACE/dashboard/

　　　　　　　　./env/bin/python wsgi.py

　　　　2）在生产环境启动

　　　　　　　　bash control start            # 在生产环境启动

　　　　　　　　bash control stop　        # 停止dashboard运行

　　　　　　　　bash control tail             # 查看日志

1.4 被监控主机安装open-falcon agent     返回顶部
　　  参考博客： https://blog.csdn.net/qq_27384769/article/details/79569776 

　　1、在被监控服务器中创建工作目录

复制代码
# 1、在被监控服务器中创建工作目录
mkdir -p /home/work/

# 2、将server端agent文件夹和启动脚本 拷贝到被监控服务器上
scp -r /home/work/agent/ root@192.168.56.13:/home/work/                 # 拷贝agent目录
scp -r /home/work/open-falcon root@192.168.56.13:/home/work/            # 拷贝启动脚本

# 3、修改配置文件
vim /home/work/agent/config/cfg.json
复制代码

复制代码
{
    &quot;debug&quot;: true,
    &quot;hostname&quot;: &quot;&quot;,
    &quot;ip&quot;: &quot;&quot;,
    &quot;plugin&quot;: {
        &quot;enabled&quot;: false,
        &quot;dir&quot;: &quot;./plugin&quot;,
        &quot;git&quot;: &quot;https://github.com/open-falcon/plugin.git&quot;,
        &quot;logs&quot;: &quot;./logs&quot;
    },
    &quot;heartbeat&quot;: {
        &quot;enabled&quot;: true,
        &quot;addr&quot;: &quot;192.168.56.12:6030&quot;,
        &quot;interval&quot;: 60,
        &quot;timeout&quot;: 1000
    },
    &quot;transfer&quot;: {
        &quot;enabled&quot;: true,
        &quot;addrs&quot;: [
            &quot;192.168.56.12:8433&quot;
        ],
        &quot;interval&quot;: 60,
        &quot;timeout&quot;: 1000
    },
    &quot;http&quot;: {
        &quot;enabled&quot;: true,
        &quot;listen&quot;: &quot;:1988&quot;,
        &quot;backdoor&quot;: false
    },
    &quot;collector&quot;: {
        &quot;ifacePrefix&quot;: [&quot;eth&quot;, &quot;em&quot;],
        &quot;mountPoint&quot;: []
    },
    &quot;default_tags&quot;: {
    },
    &quot;ignore&quot;: {
        &quot;cpu.busy&quot;: true,
        &quot;df.bytes.free&quot;: true,
        &quot;df.bytes.total&quot;: true,
        &quot;df.bytes.used&quot;: true,
        &quot;df.bytes.used.percent&quot;: true,
        &quot;df.inodes.total&quot;: true,
        &quot;df.inodes.free&quot;: true,
        &quot;df.inodes.used&quot;: true,
        &quot;df.inodes.used.percent&quot;: true,
        &quot;mem.memtotal&quot;: true,
        &quot;mem.memused&quot;: true,
        &quot;mem.memused.percent&quot;: true,
        &quot;mem.memfree&quot;: true,
        &quot;mem.swaptotal&quot;: true,
        &quot;mem.swapused&quot;: true,
        &quot;mem.swapfree&quot;: true
    }
}
复制代码
　　2、agent进程管理

　　　　　　./open-falcon start agent                  启动进程

　　　　　　./open-falcon stop agent                  停止进程

　　　　　　./open-falcon monitor agent             查看日志
</code></pre>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1422 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-02-20 08:00 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="/posts/a14/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>CMDB设计思路</span>
			</a>
			<a class="prev-post" href="/posts/a12/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>open-falcon入门篇</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="/">孙志奇</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="/js/main.min.35ccbf1cdceb91e4c64c06b5d009d6e2977fafe56beda7762febd4e67528d2ac.js" integrity="sha256-Ncy/HNzrkeTGTAa10AnW4pd/r+Vr7ad2L+vU5nUo0qw="></script>

</body>

</html>
